<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alterar Letra</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .chat-container {
      background: white;
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .chat-header h2 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .chat-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .progress-bar {
      background: rgba(255, 255, 255, 0.2);
      height: 4px;
      margin-top: 15px;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      background: white;
      height: 100%;
      width: 33%;
      transition: width 0.3s ease;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f7f9fc;
    }

    .message {
      margin-bottom: 15px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.bot {
      text-align: left;
    }

    .message.user {
      text-align: right;
    }

    .message-content {
      display: inline-block;
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
    }

    .message.bot .message-content {
      background: white;
      color: #333;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .input-section {
      padding: 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
    }

    .input-group {
      margin-bottom: 15px;
    }

    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      transition: border-color 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .char-count {
      text-align: right;
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    button.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    button.primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button.secondary {
      background: #f0f0f0;
      color: #333;
    }

    button.secondary:hover {
      background: #e0e0e0;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="modal-overlay">
    <div class="chat-container">
      <div class="chat-header">
        <h2>‚úèÔ∏è Alterar Letra</h2>
        <p>Voc√™ tem uma chance de solicitar mudan√ßas</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        <!-- Messages will be inserted here -->
      </div>

      <div class="input-section" id="inputSection">
        <!-- Input fields will be inserted here -->
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CHAT PARA ALTERA√á√ÉO DE LETRA
    // ============================================

    const SUPABASE_URL = "https://miupzfchvfbqbznfhvix.supabase.co";
    const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/alterar-letra`;

    let currentStep = 0;
    let formData = {};
    let pedidoId = null;

    // Pegar pedidoId da URL
    const urlParams = new URLSearchParams(window.location.search);
    pedidoId = urlParams.get('pedidoId');

    const chatFlow = [
      {
        step: 1,
        question: "O que voc√™ gostaria de mudar na letra? üéµ\n\nüí° Exemplos:\n- Tornar o refr√£o mais animado\n- Adicionar men√ß√£o a uma mem√≥ria espec√≠fica\n- Mudar o tom de rom√¢ntico para alegre\n- Trocar uma parte que n√£o soou bem",
        type: "textarea",
        field: "mudancas_desejadas",
        minLength: 20,
        placeholder: "Ex: Gostaria que o refr√£o fosse mais energ√©tico e mencionasse nossa viagem para o Rio..."
      },
      {
        step: 2,
        question: "H√° algo espec√≠fico que DEVE permanecer na letra? üîí",
        type: "textarea",
        field: "manter_elementos",
        minLength: 10,
        placeholder: "Ex: Mantenha as refer√™ncias a Dourados e o nome 'Aline'..."
      },
      {
        step: 3,
        question: "Alguma observa√ß√£o final sobre o tom ou estilo? üé®",
        type: "textarea",
        field: "observacoes_finais",
        required: false,
        placeholder: "Ex: Quero que seja mais emocionante, menos melanc√≥lica..."
      }
    ];

    function scrollToBottom() {
      const container = document.getElementById("chatMessages");
      setTimeout(() => {
        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
      }, 100);
    }

    function addMessage(sender, text) {
      const container = document.getElementById("chatMessages");
      const messageEl = document.createElement("div");
      messageEl.className = `message ${sender}`;
      messageEl.innerHTML = `
        <div class="message-content">${text.replace(/\n/g, '<br>')}</div>
      `;
      container.appendChild(messageEl);
      scrollToBottom();
    }

    function updateProgress() {
      const progress = ((currentStep + 1) / (chatFlow.length + 1)) * 100;
      document.getElementById("progressFill").style.width = progress + "%";
    }

    function renderQuestion() {
      const inputContainer = document.getElementById("inputSection");
      inputContainer.innerHTML = "";

      if (currentStep >= chatFlow.length) {
        submitChanges();
        return;
      }

      const question = chatFlow[currentStep];
      updateProgress();

      addMessage("bot", question.question);

      setTimeout(() => {
        const html = `
          <div class="input-group">
            <textarea 
              id="userInput" 
              placeholder="${question.placeholder}"
              maxlength="500"
              oninput="updateCharCount()"
            ></textarea>
            <div class="char-count">
              <span id="charCount">0</span>/500
            </div>
          </div>
          <div class="button-group">
            ${currentStep > 0 ? '<button class="secondary" onclick="previousStep()">‚¨ÖÔ∏è Voltar</button>' : ''}
            <button class="primary" onclick="nextStep()" id="nextBtn">
              ${currentStep === chatFlow.length - 1 ? 'Enviar Altera√ß√µes ‚ú®' : 'Pr√≥ximo ‚û°Ô∏è'}
            </button>
          </div>
        `;
        inputContainer.innerHTML = html;
        document.getElementById("userInput").focus();
        
        // Enter para avan√ßar
        document.getElementById("userInput").addEventListener("keydown", (e) => {
          if (e.key === "Enter" && e.ctrlKey) nextStep();
        });
      }, 500);
    }

    function updateCharCount() {
      const input = document.getElementById("userInput");
      const count = input.value.length;
      document.getElementById("charCount").textContent = count;
    }

    function nextStep() {
      const question = chatFlow[currentStep];
      const input = document.getElementById("userInput");
      const value = input.value.trim();

      if (question.required !== false && value.length < (question.minLength || 10)) {
        alert(`Por favor, escreva pelo menos ${question.minLength || 10} caracteres`);
        return;
      }

      formData[question.field] = value;
      addMessage("user", value || "(Nenhuma observa√ß√£o)");

      currentStep++;
      setTimeout(renderQuestion, 300);
    }

    function previousStep() {
      if (currentStep > 0) {
        currentStep--;
        // Remove last 2 messages (bot + user)
        const container = document.getElementById("chatMessages");
        container.removeChild(container.lastChild);
        container.removeChild(container.lastChild);
        renderQuestion();
      }
    }

    async function submitChanges() {
      const inputContainer = document.getElementById("inputSection");
      inputContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processando altera√ß√µes...</p></div>';

      // Montar texto de sugest√µes
      const sugestoes = `
MUDAN√áAS DESEJADAS:
${formData.mudancas_desejadas}

ELEMENTOS QUE DEVEM PERMANECER:
${formData.manter_elementos}

${formData.observacoes_finais ? `OBSERVA√á√ïES ADICIONAIS:\n${formData.observacoes_finais}` : ''}
      `.trim();

      try {
        const response = await fetch(EDGE_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedidoId: pedidoId,
            sugestoes: sugestoes
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao processar altera√ß√µes');
        }

        addMessage("bot", "‚úÖ Vers√£o modificada criada com sucesso!\n\nAgora voc√™ pode comparar as duas vers√µes e escolher sua favorita.");

        inputContainer.innerHTML = `
          <button class="primary" onclick="window.location.href='dashboard.html?pedidoId=${pedidoId}'">
            Ver Compara√ß√£o üéµ
          </button>
        `;

      } catch (error) {
        addMessage("bot", `‚ùå Erro: ${error.message}`);
        inputContainer.innerHTML = `
          <button class="primary" onclick="location.reload()">
            Tentar Novamente
          </button>
        `;
      }
    }

    // Iniciar chat
    window.addEventListener('DOMContentLoaded', () => {
      if (!pedidoId) {
        addMessage("bot", "‚ùå Erro: ID do pedido n√£o encontrado na URL");
        return;
      }
      renderQuestion();
    });
  </script>
</body>
</html>
