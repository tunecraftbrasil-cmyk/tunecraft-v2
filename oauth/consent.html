<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorizar Acesso | TuneCraft ID</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27; 
            color: #1e293b;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px;
        }

        .consent-card {
            background: white;
            border-radius: 16px;
            width: 100%; max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .header {
            background: linear-gradient(135deg, #0a0e27 0%, #1e293b 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .app-icon {
            width: 60px; height: 60px;
            background: white; border-radius: 12px;
            display: inline-flex; justify-content: center; align-items: center;
            font-size: 2rem; margin-bottom: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .body { padding: 30px; }

        h2 { margin: 0 0 10px 0; font-size: 1.4rem; color: #0f172a; text-align: center; }
        p.subtitle { text-align: center; color: #64748b; font-size: 0.95rem; margin-bottom: 30px; line-height: 1.5; }

        .user-preview {
            display: flex; align-items: center; gap: 15px;
            background: #f1f5f9; padding: 12px; border-radius: 10px;
            margin-bottom: 25px; border: 1px solid #e2e8f0;
        }

        .avatar {
            width: 40px; height: 40px; background: #00d9ff; color: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.1rem;
        }

        .user-info div { font-size: 0.9rem; font-weight: 600; }
        .user-info small { color: #64748b; font-size: 0.8rem; }

        .permissions-list { list-style: none; padding: 0; margin-bottom: 30px; }
        .permissions-list li {
            display: flex; gap: 10px; margin-bottom: 12px;
            font-size: 0.9rem; color: #334155; align-items: flex-start;
        }
        .check-icon { color: #10b981; font-weight: bold; margin-top: 2px; }

        .actions { display: flex; gap: 15px; }
        
        button {
            flex: 1; padding: 14px; border-radius: 8px; font-weight: 700; cursor: pointer;
            font-size: 0.95rem; transition: 0.2s; border: none;
        }

        .btn-cancel { background: #f1f5f9; color: #64748b; }
        .btn-cancel:hover { background: #e2e8f0; color: #334155; }

        .btn-allow { background: #00d9ff; color: white; box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3); }
        .btn-allow:hover { background: #00b8d9; transform: translateY(-2px); }

    </style>
</head>
<body>

    <div class="consent-card">
        <div class="header">
            <div class="app-icon">üîê</div>
            <h3>Autoriza√ß√£o Necess√°ria</h3>
        </div>

        <div class="body">
            <h2 id="appName">Aplicativo Externo</h2>
            <p class="subtitle">Este aplicativo deseja acessar sua conta <strong>TuneCraft</strong> para:</p>

            <div class="user-preview">
                <div class="avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <div id="userName">Carregando...</div>
                    <small id="userEmail">...</small>
                </div>
            </div>

            <ul class="permissions-list">
                <li><span class="check-icon">‚úì</span> Ler seus dados de perfil pessoal</li>
                <li><span class="check-icon">‚úì</span> Ver suas m√∫sicas e pedidos criados</li>
            </ul>

            <div class="actions">
                <button class="btn-cancel" onclick="deny()">Cancelar</button>
                <button class="btn-allow" onclick="allow()">Autorizar</button>
            </div>
        </div>
    </div>

    <script>
        // 1. Verifica se est√° logado (Mesma l√≥gica do Dashboard)
        const userData = JSON.parse(localStorage.getItem("tuneCraftUser"));
        
        if (!userData || !userData.email) {
            // Se n√£o estiver logado, manda pro login e volta pra c√° depois
            // Codificamos a URL atual para voltar nela depois do login
            const currentUrl = encodeURIComponent(window.location.href);
            window.location.href = `../login.html?redirect=${currentUrl}`;
        } else {
            // Preenche dados do usu√°rio
            document.getElementById("userName").innerText = userData.name;
            document.getElementById("userEmail").innerText = userData.email;
            document.getElementById("userAvatar").innerText = userData.name.charAt(0).toUpperCase();
        }

        // 2. Processa os par√¢metros da URL (Vindos do fluxo OAuth)
        const params = new URLSearchParams(window.location.search);
        const clientId = params.get('client_id') || 'Aplica√ß√£o Desconhecida';
        const redirectUri = params.get('redirect_uri');
        const state = params.get('state');

        // Mostra o ID do cliente na tela
        document.getElementById("appName").innerText = `O app "${clientId}" quer acesso`;

        // 3. Fun√ß√£o de Autorizar
        function allow() {
            if (!redirectUri) return alert("Erro: Redirect URI n√£o fornecida na URL.");

            // === L√ìGICA DE PROTOTIPAGEM ===
            // Em um OAuth Server real, aqui voc√™ chamaria sua API backend para:
            // supabase.auth.admin.acceptOAuthAuthorization(userId, clientId)
            // Como estamos no front-end simulado, vamos redirecionar com um c√≥digo fake.
            
            const fakeAuthCode = "tune_code_" + Math.random().toString(36).substr(2, 9);
            
            // Monta a URL de retorno
            let returnUrl = new URL(redirectUri);
            returnUrl.searchParams.append('code', fakeAuthCode);
            if (state) returnUrl.searchParams.append('state', state);

            document.querySelector('.btn-allow').innerText = "Redirecionando...";
            setTimeout(() => {
                window.location.href = returnUrl.toString();
            }, 800);
        }

        // 4. Fun√ß√£o de Negar
        function deny() {
            if (!redirectUri) return window.location.href = "../dashboard.html";

            let returnUrl = new URL(redirectUri);
            returnUrl.searchParams.append('error', 'access_denied');
            if (state) returnUrl.searchParams.append('state', state);

            window.location.href = returnUrl.toString();
        }
    </script>
</body>
</html>